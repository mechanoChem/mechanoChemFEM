<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>mechanoChemFEM: Battery model at electrode scale</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">mechanoChemFEM
   &#160;<span id="projectnumber">0.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="codestructure.html"><span>Code&#160;structure</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="modules.html"><span>Functions</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Battery model at electrode scale </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Introduction"></a>
Introduction</h1>
<p>A battery cell usually consists of porous, positive and negative electrodes, a separator and a current collector. This example present coupled continuum formulation for the electrostatic, chemical, thermal and mechanical processes in battery materials. The treatment applies on the macroscopic scale, at which electrodes can be modelled as porous materials made up of active particles held together by binders and perfused by the electrolyte.</p>
<p>This code is used to generate results for paper: <b>Intercalation driven porosity effects on the electro-chemo-thermo-mechanical response in continuum models for battery material electrodes</b>, Z. Wang, J. Siegel, K. Garikipati, Journal of the Electrochemical Society, Vol. 164: A2199-A2212, 2017, doi:10.1149/2.0081712jes  <style>div.image img[src="full_3d_micro_structure.png"]{width:700px;}</style>  <div class="image">
<img src="full_3d_micro_structure.png" alt="full_3d_micro_structure.png"/>
<div class="caption">
A schematic of the three-dimensional cell showing porous electrodes and separator. In this model, the electrolyte fills the pores. The current collectors are not shown.</div></div>
<h2><a class="anchor" id="section1"></a>
The multi-physics particle scale model</h2>
<h3><a class="anchor" id="subsub1"></a>
Electro-chemo-thermal equations</h3>
<p><b>The electrochemical equations for finitely deforming electrodes</b><br/>
 The ordinary differential equation for mass balance of lithium: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{\partial}{\partial t}({\epsilon_\text{s}C_\text{Li}})+\epsilon_\text{s}{a_\text{p}}j_n=0 \]" src="form_0.png"/>
</p>
<p> where <img class="formulaInl" alt="$C_\text{Li}$" src="form_1.png"/> is the concentration of lithium in the deformed configuration, <img class="formulaInl" alt="$\epsilon_\text{s}$" src="form_2.png"/> is the volume fraction of solid particles, and <img class="formulaInl" alt="$a_\text{p}$" src="form_3.png"/> is related to the inverse radius. For spherical particles of radius <img class="formulaInl" alt="$R_\text{p}$" src="form_4.png"/>, it is defined as <img class="formulaInl" alt="$a_\text{p} = 3/R_\text{p}$" src="form_5.png"/>. Finally, <img class="formulaInl" alt="$j_n$" src="form_6.png"/> is the normal flux of lithium on the particle's surface.</p>
<p>The partial differential equation for mass balance of lithium ions, <img class="formulaInl" alt="$C_{\text{Li}^+}$" src="form_7.png"/>: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{\partial }{\partial t}(\epsilon_\text{l}C_{\text{Li}^+})=\nabla\cdot (\epsilon_\text{l}D_\text{eff}\nabla C_{\text{Li}^+})+(1-t^0_+)\epsilon_\text{s}{a_\text{p}}j_n. \]" src="form_8.png"/>
</p>
<p> where <img class="formulaInl" alt="$\epsilon_\text{l}$" src="form_9.png"/> is the volume fraction of pores in the electrode, <img class="formulaInl" alt="$t^0_+$" src="form_10.png"/> is the lithium ion transference number, and $D_{eff}$ is the effective diffusivity.</p>
<p>The equations for the electric fields are, </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \nabla\cdot\left(\gamma_\text{eff}(-\nabla\phi_\text{E})+\gamma_\text{eff}\frac{2R\theta}{F}(1-t^{0}_{+})\nabla\ln C_{2}\right)=a_\text{p}Fj_{n} \]" src="form_11.png"/>
</p>
 <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \nabla\cdot\left(\sigma_\text{eff}(-\nabla\phi_\text{S})\right)=-a_\text{p}Fj_{n} \]" src="form_12.png"/>
</p>
<p> where <img class="formulaInl" alt="$\phi_\text{E}$" src="form_13.png"/> and <img class="formulaInl" alt="$\phi_\text{S}$" src="form_14.png"/> are, respectively, the electric potential fields in the electrolyte and solid, <img class="formulaInl" alt="$\gamma_\text{eff}$" src="form_15.png"/> and <img class="formulaInl" alt="$\sigma_\text{eff}$" src="form_16.png"/> are the corresponding effective conductivities which depend on the porosity, <img class="formulaInl" alt="$R$" src="form_17.png"/> is the universal gas constant and <img class="formulaInl" alt="$\theta$" src="form_18.png"/> is the temperature.</p>
<p>The electrochemical equations are completed with specification of the Butler-Volmer model for the flux of lithium, <img class="formulaInl" alt="$j_n$" src="form_6.png"/>: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ j_n=j_0\left(\text{exp}\left(\frac{\alpha_aF}{R\theta}(\phi_\text{S}-\phi_\text{E}-U)\right)-\text{exp}\left(-\frac{\alpha_aF}{R\theta}(\phi_\text{S}-\phi_\text{E}-U)\right)\right)\\ j_0=k_0(C_2)^{\alpha_a} \frac{(C_1^{\text{max}}-C_{1_\text{Li}})^{\alpha_a}}{(C_1^{\text{max}})^{\alpha_a}} \frac{(C_{1_\text{Li}})^{\alpha_c}}{{(C_1^\text{max}})^{\alpha_c}} \]" src="form_19.png"/>
</p>
<p> where <img class="formulaInl" alt="$\alpha_a, \alpha_c$" src="form_20.png"/> are transfer coefficients, <img class="formulaInl" alt="$k_0$" src="form_21.png"/> is a kinetic rate constant,and <img class="formulaInl" alt="$C^{\text{max}}_\text{Li}$" src="form_22.png"/> is the maximum concentration of lithium that the particle can contain. The open circuit potential <img class="formulaInl" alt="$U$" src="form_23.png"/> can be written as a fit depend on <img class="formulaInl" alt="$C_\text{Li}$" src="form_1.png"/>.</p>
<p><b>The standard thermal equations</b><br/>
 Heat generation and transport are governed by the heat equation, which is derived from the first law of thermodynamics. For the temperature $$, we have the standard form of the heat equation in the electrodes: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho C_p\frac{\text{d}\theta}{\text{d}t}=\lambda \nabla^2\theta+Q_{\text{rxn}}+Q_{\text{rev}}+Q_{\text{ohm}} \label{eq:ThermalElectrode} \]" src="form_24.png"/>
</p>
<p> where f <img class="formulaInl" alt="$\rho$" src="form_25.png"/> is the mass density of the electrode, <img class="formulaInl" alt="$C_p$" src="form_26.png"/> is specific heat and <img class="formulaInl" alt="$\lambda$" src="form_27.png"/> is the thermal conductivity. In the separator, we have: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \rho C_p\frac{\text{d}\theta}{\text{d}t}=\lambda \nabla^2\theta+Q_{\text{ohm}}. \]" src="form_28.png"/>
</p>
<p> The heat generation terms are: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ Q_{\text{rxn}}=Faj_n(\phi_\text{S}-\phi_\text{E}-U) \quad \text{irreversible entropic heat}\\ Q_{\text{rev}}=Faj_n\theta\frac{\partial U}{\partial \theta} \quad\text{reversible entropic heat}\\ Q_{\text{ohm}}=-\boldsymbol{i}_1\cdot\nabla\phi_\text{S}-\boldsymbol{i}_2\cdot\nabla\phi_\text{E} \quad\text{Joule heating in electrode}\\ Q_{\text{ohm}}=-\boldsymbol{i}_2\cdot\nabla\phi_\text{E} \quad\text{Joule heating in separator} \]" src="form_29.png"/>
</p>
<h3><a class="anchor" id="subsub2"></a>
Finite strain mechanics and the evolving porosity model</h3>
<p>Lithium intercalation/de-intercalation induces particle swelling/contraction which manifests itself as electrode deformation at the macro-scale. Additionally, the particle and separator undergo thermal expansion.{{blue}The electrolyte is assumed not to undergo thermal expansion. Therefore the decomposition of the deformation into elastic, swelling and thermal contributions does not apply to it.} The kinematics of finite strain leads to the following decomposition: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \boldsymbol{F}=\boldsymbol{F}^\text{e}\boldsymbol{F}^\text{c}\boldsymbol{F}^{\theta} \]" src="form_30.png"/>
</p>
<p> where <img class="formulaInl" alt="$\boldsymbol{F} = \boldsymbol{1} + \partial\boldsymbol{u}/\partial\boldsymbol{X}$" src="form_31.png"/>, is the total deformation gradient tensor averaged over the constituents of the material. It is multiplicatively decomposed into <img class="formulaInl" alt="$\boldsymbol{F}^\text{e}$" src="form_32.png"/>, <img class="formulaInl" alt="$\boldsymbol{F}^\text{c}$" src="form_33.png"/> and <img class="formulaInl" alt="$\boldsymbol{F}^{\theta}$" src="form_34.png"/>, which are, respectively, its elastic, chemical (induced by lithium intercalation) and thermal components. In the absence of a body force the strong form of the mechanics problem in the current configuration is </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \nabla\cdot\boldsymbol{T} = \boldsymbol{0} \\ \boldsymbol{T}= \frac{1}{\det{\boldsymbol{F}^\text{e}}}\frac{\partial W}{\partial \boldsymbol{F}^\text{e}}\boldsymbol{F}^{\text{e}^\text{T}} \]" src="form_35.png"/>
</p>
<p> where $$ is the Cauchy stress tensor and $W$ is the strain energy density function.</p>
<p>we assume that although the particles undergo isotropic swelling in the electrode due to intercalation of lithium, there is unidirectional swelling along the normal to the separator. This assumption models the non-slip boundary condition that would be applied at the current collector-electrode interface, and which would provide a strong constraint against macroscopic expansion of the electrode in the e1 and e3 directions. Since we do not directly model the current collector, this assumption represents its mechanical effect Accordingly, we have </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ F^\text{c}_{iJ}=\beta\delta_{2i}\delta_{2J}+\delta_{iJ} \]" src="form_36.png"/>
</p>
<p> Thermal expansion is modelled as isotropic </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ F^{\theta}_{iJ}=(1+\beta^{\theta})^{1/3}\delta_{iJ} \]" src="form_37.png"/>
</p>
<p> Based on mixture theory (Z. Wang et.al.), the volume fraction of particle in electrode can be modeled by </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \epsilon_\text{s}=\frac{\left( \frac{\kappa(\frac{\det\boldsymbol{F}}{(1+\beta)(1+\beta^\theta)}-1)-3P_\text{l}-3P_\text{b}}{\kappa_\text{s}} +1\right)(1+\beta_\text{s})(1+\beta_\text{s}^\theta)}{\det\boldsymbol{F}}\epsilon_{\text{s}_0} \]" src="form_38.png"/>
</p>
<p> Assuming the binder to deform at constant volume during charging and discharging such that ${det}{F}_{b}=1$, we have </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \epsilon_\text{b}=\frac{1}{\det \boldsymbol{F}}\epsilon_{\text{b}_0}\\ \epsilon_\text{l}=1-\epsilon_{\text{s}}-\epsilon_\text{b} \]" src="form_39.png"/>
</p>
 <h2><a class="anchor" id="sub2"></a>
Boundary condition</h2>
 <style>div.image img[src="3d-solving-domain.png"]{width:700px;}</style>  <div class="image">
<img src="3d-solving-domain.png" alt="3d-solving-domain.png"/>
<div class="caption">
A schematic of the initial/boundary value problem showing the fields solved for in the electrode and separator sub-domains, with the surfaces labelled.</div></div>
<h1><a class="anchor" id="Implementation"></a>
Implementation: level 0 developer</h1>
<h2><a class="anchor" id="sub1"></a>
Read parameters.prm before defining primary variables over different domains</h2>
<p>Here, we want to read the paramters from file at the very beginning of main.cc instead of at run.cc. This is can be easily done at main.cc </p>
<div class="fragment"><div class="line">ParameterHandler params;</div>
<div class="line"><a class="code" href="classinit_bound_val_probs.html">initBoundValProbs&lt;DIMS&gt;</a> problem(params);</div>
<div class="line">ElectricChemo&lt;Sacado::Fad::DFad&lt;double&gt;,DIMS&gt; _electricChemoFormula(params);</div>
<div class="line">problem.electricChemoFormula=&amp;_electricChemoFormula;</div>
<div class="line">problem.declare_parameters();</div>
<div class="line">params.read_input (<span class="stringliteral">&quot;parameters.prm&quot;</span>);</div>
</div><!-- fragment --><p> Then we can read the domain id, and Define primary variables over different domains just like Example 1 </p>
<div class="fragment"><div class="line">params.enter_subsection(<span class="stringliteral">&quot;Problem&quot;</span>); </div>
<div class="line"><span class="keywordtype">int</span> separator_fe=params.get_integer(<span class="stringliteral">&quot;separator_fe&quot;</span>);</div>
<div class="line"><span class="keywordtype">int</span> electrode_fe=params.get_integer(<span class="stringliteral">&quot;electrode_fe&quot;</span>);</div>
<div class="line">params.leave_subsection();</div>
<div class="line"></div>
<div class="line"><span class="comment">//main fields </span></div>
<div class="line">std::vector&lt;std::vector&lt;std::string&gt; &gt; primary_variables(6);<span class="comment">//u; c_li_plus;phi_e;c_li;phi_s;T   </span></div>
<div class="line">primary_variables[0].push_back(<span class="stringliteral">&quot;u&quot;</span>); primary_variables[0].push_back(<span class="stringliteral">&quot;component_is_vector&quot;</span>);</div>
<div class="line">primary_variables[1].push_back(<span class="stringliteral">&quot;C_li_plus&quot;</span>); primary_variables[1].push_back(<span class="stringliteral">&quot;component_is_scalar&quot;</span>);</div>
<div class="line">primary_variables[2].push_back(<span class="stringliteral">&quot;phi_e&quot;</span>); primary_variables[2].push_back(<span class="stringliteral">&quot;component_is_scalar&quot;</span>);</div>
<div class="line">primary_variables[3].push_back(<span class="stringliteral">&quot;C_li&quot;</span>); primary_variables[3].push_back(<span class="stringliteral">&quot;component_is_scalar&quot;</span>);</div>
<div class="line">primary_variables[4].push_back(<span class="stringliteral">&quot;phi_s&quot;</span>); primary_variables[4].push_back(<span class="stringliteral">&quot;component_is_scalar&quot;</span>);</div>
<div class="line">primary_variables[5].push_back(<span class="stringliteral">&quot;T&quot;</span>); primary_variables[5].push_back(<span class="stringliteral">&quot;component_is_scalar&quot;</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">//active material, separator, currentCollector, pure solid</span></div>
<div class="line"><span class="keywordtype">int</span> number_domain=2;</div>
<div class="line">std::vector&lt;std::vector&lt;int&gt; &gt; FE_support(number_domain);<span class="comment">// store order of polynomial basis functions, 0 means FE_Nothing   </span></div>
<div class="line"><span class="comment">//electrode domain</span></div>
<div class="line">FE_support[separator_fe].push_back(1);<span class="comment">//u</span></div>
<div class="line">FE_support[separator_fe].push_back(1);<span class="comment">//C_li_plus</span></div>
<div class="line">FE_support[separator_fe].push_back(1);<span class="comment">//phi_e</span></div>
<div class="line">FE_support[separator_fe].push_back(0);<span class="comment">//C_li</span></div>
<div class="line">FE_support[separator_fe].push_back(0);<span class="comment">//phi_s</span></div>
<div class="line">FE_support[separator_fe].push_back(1);<span class="comment">//T</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//separator</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//u</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//C_li_plus</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//phi_e</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//C_li</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//phi_s</span></div>
<div class="line">FE_support[electrode_fe].push_back(1);<span class="comment">//T</span></div>
</div><!-- fragment --><h2><a class="anchor" id="Generate"></a>
Generate mesh internally</h2>
<p>In Example 1, mesh is imported from existing mesh. Here we use deal.ii <b>GridGenerator</b> to generate mesh </p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; element_div_x; ++j) step_sizes[0].push_back((X_end-X_0)/element_div_x); </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; element_div_y; ++j) step_sizes[1].push_back((Y_end-Y_0)/element_div_y);</div>
<div class="line"><span class="keywordflow">if</span>(dim==3)<span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; element_div_z; ++j) step_sizes[2].push_back((Z_end-Z_0)/element_div_z);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>(dim==2) GridGenerator::subdivided_hyper_rectangle (this-&gt;triangulation, step_sizes, Point&lt;dim&gt;(X_0,Y_0), Point&lt;dim&gt;(X_end,Y_end), colorize);</div>
<div class="line"><span class="keywordflow">else</span> GridGenerator::subdivided_hyper_rectangle (this-&gt;triangulation, step_sizes, Point&lt;dim&gt;(X_0,Y_0,Z_0), Point&lt;dim&gt;(X_end,Y_end,Z_end), colorize);</div>
</div><!-- fragment --><h2><a class="anchor" id="Finite"></a>
Finite strain mechanics using Saint Venant Kirchhoff model</h2>
<p>After we have elastic deformation gradient tensor <b>Fe</b>, we need to choose the constitutive model for mechanics </p>
<div class="fragment"><div class="line"><a class="code" href="class_residual.html#a4b181b84ebad5e2adb629b4a542dc9c6">Residual&lt;vectorType,dim&gt;::evaluateStrain</a>(Fe, E, defMap, infinitesimal_strain_indicator);</div>
<div class="line"><a class="code" href="class_residual.html#a4215ec5a6eabd7573e0caeee6fd194ad">Residual&lt;vectorType,dim&gt;::evaluateSaint_Venant_KirchhoffStress</a>(P_stress,Fe, E);</div>
<div class="line"><a class="code" href="class_residual.html#a432fe02216f182fd241f09775131f854">Residual&lt;vectorType,dim&gt;::residualForMechanics</a>(fe_values, u_dof, R, P_stress);  </div>
</div><!-- fragment --><h2><a class="anchor" id="neumann"></a>
Apply neumann boundary condition</h2>
<p>In this example we need to apply neumann boundary condition for heat dissipation and current. We need to first find the corresponding surface, and use function <b>residualForNeummanBC</b>. </p>
<div class="fragment"><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> faceID=0; faceID&lt;2*dim; faceID++){</div>
<div class="line">    <span class="keywordflow">if</span>(cell-&gt;face(faceID)-&gt;at_boundary()){</div>
<div class="line">        FEFaceValues&lt;dim&gt;* fe_face_values;</div>
<div class="line">        <span class="keywordflow">if</span>(domain==1 or domain==-1) fe_face_values=&amp;electrode_fe_face_values;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(domain==0) fe_face_values=&amp;separator_fe_face_values;</div>
<div class="line">        fe_face_values-&gt;reinit (cell, faceID);</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_face_quadrature_points = fe_face_values-&gt;n_quadrature_points;</div>
<div class="line">        dealii::Table&lt;1,Sacado::Fad::DFad&lt;double&gt; &gt; T_face(n_face_quadrature_points),heat_transfer(n_face_quadrature_points);</div>
<div class="line">        <a class="code" href="group___evaluation_functions.html#ga399ae2353249293211c021848a64175c">evaluateScalarFunction</a>(fe_values, *fe_face_values, T_dof, ULocal, T_face);</div>
<div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q=0;q&lt;n_face_quadrature_points;q++) heat_transfer[q]=h*(T_face[q]-T_ini);</div>
<div class="line">        <a class="code" href="class_residual.html#a4c8fd158c8034b25780abfe785755baa">Residual&lt;vectorType,dim&gt;::residualForNeummanBC</a>(fe_values, *fe_face_values, T_dof, R, heat_transfer);</div>
<div class="line">        <span class="keywordflow">if</span>(cell-&gt;face(faceID)-&gt;boundary_id()==dim*2 ){</div>
<div class="line">            <span class="keywordtype">double</span> current;</div>
<div class="line">            <span class="keywordflow">if</span>(cell_center[1]&lt;=electrode_Y1) current=current_IpA;</div>
<div class="line">            <span class="keywordflow">else</span> current=-current_IpA;</div>
<div class="line">            <a class="code" href="class_residual.html#a4c8fd158c8034b25780abfe785755baa">Residual&lt;vectorType,dim&gt;::residualForNeummanBC</a>(fe_values, *fe_face_values, phi_s_dof, R, current);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}   </div>
</div><!-- fragment --> <h2><a class="anchor" id="Scalling"></a>
Residual scalling</h2>
<p>In battery modelling, the value of parameters may differ a lot, and scalling may be necessary before solving. And this is can be easilly done using function <b>scalling</b>. </p>
<div class="fragment"><div class="line">ResidualEq-&gt;scalling(fe_values,c_li_plus_dof,R,1e-3);</div>
<div class="line">ResidualEq-&gt;scalling(fe_values,phi_e_dof,R,1e-3);</div>
<div class="line">ResidualEq-&gt;scalling(fe_values,c_li_dof,R,1e-5);</div>
<div class="line">ResidualEq-&gt;scalling(fe_values,phi_s_dof,R,1e-6);</div>
<div class="line">ResidualEq-&gt;scalling(fe_values,T_dof,R,1e-5);</div>
</div><!-- fragment --><h2><a class="anchor" id="computed"></a>
Output extral field computed from primary variabls</h2>
<p>During battery simulation, reaction rate is a important intermidate results and we want to output it along with the primary variables. To do so we first need to implement a class derived from <b>computedField&lt;dim&gt;</b>. </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;deal.II/base/parameter_handler.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="computed_field_8h.html">supplementary/computedField.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;electricChemo.h&quot;</span></div>
<div class="line">\code{.cpp}</div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keyword">class </span>nodalField : <span class="keyword">public</span> <a class="code" href="classcomputed_field.html">computedField</a>&lt;dim&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    nodalField(dealii::ParameterHandler&amp; _params);</div>
<div class="line">    ~nodalField();</div>
<div class="line">    </div>
<div class="line">    dealii::ParameterHandler* params;</div>
<div class="line">    <span class="keywordtype">void</span> compute_derived_quantities_vector(<span class="keyword">const</span> std::vector&lt;Vector&lt;double&gt; &gt; &amp;uh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;std::vector&lt;Tensor&lt;1,dim&gt; &gt; &gt; &amp;duh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;std::vector&lt;Tensor&lt;2,dim&gt; &gt; &gt; &amp;dduh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt; &gt;                  &amp;normals,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt; &gt;                  &amp;evaluation_points,</div>
<div class="line">                           std::vector&lt;Vector&lt;double&gt; &gt;                    &amp;computed_quantities) <span class="keyword">const</span>;</div>
<div class="line">                                 </div>
<div class="line">    </div>
<div class="line">                                 <span class="comment">//std::vector&lt;std::string&gt; get_names () const;</span></div>
<div class="line">                                 <span class="comment">//std::vector&lt;DataComponentInterpretation::DataComponentInterpretation&gt; get_data_component_interpretation () const;</span></div>
<div class="line">                                 <span class="comment">//virtual UpdateFlags get_needed_update_flags () const;</span></div>
<div class="line">                                 <span class="comment">//void setupComputedField(std::vector&lt;std::vector&lt;std::string&gt; &gt; _primary_variables);</span></div>
<div class="line">                                                             </div>
<div class="line">    std::vector&lt;unsigned int &gt; primary_variables_dof;</div>
<div class="line">    <span class="comment">//std:</span></div>
</div><!-- fragment --><p> And overload function <b>compute_derived_quantities_vector</b> for the new field: </p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">int</span> dim&gt;</div>
<div class="line"><span class="keywordtype">void</span> nodalField&lt;dim&gt;::compute_derived_quantities_vector(<span class="keyword">const</span> std::vector&lt;Vector&lt;double&gt; &gt; &amp;uh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;std::vector&lt;Tensor&lt;1,dim&gt; &gt; &gt; &amp;duh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;std::vector&lt;Tensor&lt;2,dim&gt; &gt; &gt; &amp;dduh,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt; &gt;                  &amp;normals,</div>
<div class="line">                           <span class="keyword">const</span> std::vector&lt;Point&lt;dim&gt; &gt;                  &amp;evaluation_points,</div>
<div class="line">                           std::vector&lt;Vector&lt;double&gt; &gt;                    &amp;computed_quantities)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    ElectricChemo&lt;double,dim&gt; electricChemoFormula;</div>
<div class="line">    electricChemoFormula.params=params;</div>
<div class="line">    electricChemoFormula.setParametersFromHandler();</div>
<div class="line"></div>
<div class="line">    params-&gt;enter_subsection(<span class="stringliteral">&quot;Geometry&quot;</span>);</div>
<div class="line">    <span class="keywordtype">double</span> electrode_Y1=params-&gt;get_double(<span class="stringliteral">&quot;electrode_Y1&quot;</span>);</div>
<div class="line">    <span class="keywordtype">double</span> electrode_Y2=params-&gt;get_double(<span class="stringliteral">&quot;electrode_Y2&quot;</span>);</div>
<div class="line">  params-&gt;leave_subsection();</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">int</span> u_dof=primary_variables_dof[0];</div>
<div class="line">    <span class="keywordtype">int</span> c_li_plus_dof=primary_variables_dof[1];</div>
<div class="line">    <span class="keywordtype">int</span> phi_e_dof=primary_variables_dof[2];</div>
<div class="line">    <span class="keywordtype">int</span> c_li_dof=primary_variables_dof[3];</div>
<div class="line">    <span class="keywordtype">int</span> phi_s_dof=primary_variables_dof[4];</div>
<div class="line">    <span class="keywordtype">int</span> T_dof=primary_variables_dof[5];</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dof_per_node = uh.size();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> q=0; q&lt;dof_per_node; ++q){</div>
<div class="line">        computed_quantities[q][0]=0;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">double</span> c_li_plus, phi_e, c_li, phi_s, T;</div>
<div class="line">        c_li_plus=uh[q][c_li_plus_dof];</div>
<div class="line">        phi_e=uh[q][phi_e_dof];</div>
<div class="line">        c_li=uh[q][c_li_dof];</div>
<div class="line">        phi_s=uh[q][phi_s_dof];</div>
<div class="line">        T=uh[q][T_dof];</div>
<div class="line">        <span class="keywordtype">int</span> domain;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span>(evaluation_points[q][1]&lt;=electrode_Y1) domain=-1;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(evaluation_points[q][1]&gt;=electrode_Y2)domain=1;</div>
<div class="line">        <span class="keywordflow">else</span> domain=0;</div>
<div class="line">        computed_quantities[q][0]=electricChemoFormula.formula_jn(T, c_li, c_li_plus, phi_s, phi_e, domain);        </div>
<div class="line">    }   </div>
<div class="line">}</div>
</div><!-- fragment --><p>Then before write KTK file, we need to pass the class to <b>FEMdata&lt;dim,PETScWrappers::MPI::Vector&gt;</b> </p>
<div class="fragment"><div class="line">    nodalField&lt;dim&gt; computedNodalField(*params);</div>
<div class="line">    std::vector&lt;std::vector&lt;std::string&gt; &gt; computed_primary_variables={{<span class="stringliteral">&quot;jn&quot;</span>, <span class="stringliteral">&quot;component_is_scalar&quot;</span>}};</div>
<div class="line">    <span class="comment">//computed_primary_variables[0].push_back(&quot;jn&quot;); computed_primary_variables[0].push_back(&quot;component_is_scalar&quot;);</span></div>
<div class="line">    computedNodalField.setupComputedField(computed_primary_variables);</div>
<div class="line">    computedNodalField.primary_variables_dof=primary_variables_dof;</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line">    <a class="code" href="class_f_e_mdata.html">FEMdata&lt;dim,vectorType&gt;::data_out</a>.add_data_vector (localized_U, computedNodalField);</div>
<div class="line">    std::string output_path = output_directory+<span class="stringliteral">&quot;output-&quot;</span>+std::to_string(current_increment)+<span class="stringliteral">&quot;.vtk&quot;</span>;</div>
<div class="line">    <a class="code" href="class_f_e_mdata.html#a62d54e01135c4ab0b58f51441732dca3">FEMdata&lt;dim,vectorType&gt;::write_vtk</a>(solution_prev, output_path); </div>
</div><!-- fragment --><h3><a class="anchor" id="Pa"></a>
Parameterhandler is used to manage all parameters as Example 1</h3>
<h1><a class="anchor" id="results"></a>
Results</h1>
<p>We present few results here by using the following Parameter file: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#parameters file</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#1. Thermal modeling of cylindrical lithium ion battery during discharge cycle, Dong Hyup Jeon ⇑,1, Seung Man Baek,2011,Energy Conversion and Management LiC6</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"># 2. Numerical study on lithium titanate battery thermal response under adiabatic condition,Qiujuan Sun a, Qingsong Wanga 2015, Energy Conversion and Management</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#3.white Theoretical Analysis of Stresses in a Lithium Ion Cell    </span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#4 A Computational Model of the Mechanical Behavior within Reconstructed LixCoO2 Li-ion Battery Cathode Particles, Veruska Malavé, J.R. Berger, EA</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#5. A pseudo three-dimensional electrochemicalethermal model of a prismatic LiFePO4 battery during discharge process</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#6. solid diffusion Single-Particle Model for a Lithium-Ion Cell: Thermal Behavior, Meng Guo,a Godfrey Sikha,b,* and Ralph E. Whitea</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#global parameters</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#declare problem setting</span></div>
<div class="line"><span class="preprocessor"></span>subsection Problem</div>
<div class="line">set print_parameter = <span class="keyword">true</span></div>
<div class="line">set dt = 10</div>
<div class="line">set totalTime = 370</div>
<div class="line">set step_load = <span class="keyword">false</span></div>
<div class="line"></div>
<div class="line">set first_domain_id = 0</div>
<div class="line">set electrode_id=0</div>
<div class="line">set separator_id=1</div>
<div class="line"></div>
<div class="line">set electrode_fe=0</div>
<div class="line">set separator_fe=1</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#directory</span></div>
<div class="line"><span class="preprocessor"></span>set output_directory = output/</div>
<div class="line">set snapshot_directory = snapshot/ </div>
<div class="line"><span class="preprocessor">#FEM</span></div>
<div class="line"><span class="preprocessor"></span>set volume_quadrature = 4 </div>
<div class="line">set face_quadrature = 3 </div>
<div class="line"><span class="preprocessor">#applied current</span></div>
<div class="line"><span class="preprocessor"></span>set IpA = -100</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># some useful geometry information beforehand</span></div>
<div class="line"><span class="preprocessor"></span>subsection Geometry</div>
<div class="line">set X_0 = 0</div>
<div class="line">set Y_0 = 0</div>
<div class="line">set Z_0 = 0</div>
<div class="line">set X_end = 120</div>
<div class="line">set Y_end = 120</div>
<div class="line">set Z_end = 85</div>
<div class="line"></div>
<div class="line">set electrode_Y1 = 60</div>
<div class="line">set electrode_Y2 = 80</div>
<div class="line"></div>
<div class="line">set element_div_x = 1</div>
<div class="line">set element_div_y = 120</div>
<div class="line">set element_div_z = 1</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># initial condition</span></div>
<div class="line"><span class="preprocessor"></span>subsection Initial condition</div>
<div class="line">set c_li_max_neg = 28.7e-3</div>
<div class="line">set c_li_max_pos = 37.5e-3</div>
<div class="line">set c_li_100_neg = 0.915</div>
<div class="line">set c_li_100_pos = 0.022</div>
<div class="line">set c_li_0_neg = 0.02</div>
<div class="line">set c_li_0_pos = 0.98</div>
<div class="line">set c_li_plus_ini = 1.0e-3</div>
<div class="line">set T_0 = 298</div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># parameter for elastiticy equations</span></div>
<div class="line"><span class="preprocessor"></span>subsection Elasticity</div>
<div class="line">set youngsModulus_neg = 12e3 #cite 3 in porosity paper</div>
<div class="line">set youngsModulus_pos = 370e3 #cite4</div>
<div class="line">set youngsModulus_sep = 0.5e3 #cite 3 in porosity paper</div>
<div class="line"></div>
<div class="line">set nu_sep = 0.35 #cite 3 in porosity paper</div>
<div class="line">set nu_neg = 0.3 #cite 3 in porosity paper</div>
<div class="line">set nu_pos = 0.2 #cite4 </div>
<div class="line"></div>
<div class="line">set kappa_sep = 0.42e-3</div>
<div class="line">set kappa_neg = 4.94e-3</div>
<div class="line">set kappa_pos = 7.4e-3</div>
<div class="line">set kappa_s = 25e-3</div>
<div class="line">set pb = 0</div>
<div class="line">set pl = 0</div>
<div class="line">set omega_s = 3.5 #not used but 3.5 is from linear coff in porosity paper</div>
<div class="line"><span class="preprocessor">#following from cite 3 in porosity paper</span></div>
<div class="line"><span class="preprocessor"></span>set omega_neg = 9.615e-6 </div>
<div class="line">set omega_pos = 6.025e-6</div>
<div class="line">set omega_sep = 82.46e-5</div>
<div class="line"></div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># parameter for electro-chemo equations</span></div>
<div class="line"><span class="preprocessor"></span>subsection ElectroChemo #cite6</div>
<div class="line">set sigma_neg = 1.5e8</div>
<div class="line">set sigma_pos = 0.5e8</div>
<div class="line"></div>
<div class="line">set t_0 = 0.2</div>
<div class="line">set D_li_neg = 5e-1 #cite 40 in porosity paper in code use expression cite 3 </div>
<div class="line">set D_li_pos = 1.0e-1 #cite3</div>
<div class="line"></div>
<div class="line">set eps_s_0_neg = 0.53</div>
<div class="line">set eps_s_0_pos = 0.5</div>
<div class="line">set eps_s_0_sep = 0.35</div>
<div class="line"></div>
<div class="line">set eps_l_0_neg = 0.32</div>
<div class="line">set eps_l_0_pos = 0.35</div>
<div class="line">set eps_l_0_sep = 0.65</div>
<div class="line"></div>
<div class="line">set eps_b_0_neg = 0.15</div>
<div class="line">set eps_b_0_pos = 0.15</div>
<div class="line">set eps_b_0_sep = 0</div>
<div class="line"></div>
<div class="line">set R_s_0_neg = 8.0</div>
<div class="line">set R_s_0_pos = 6.0</div>
<div class="line">set R_s_0_sep = 0.0</div>
<div class="line"></div>
<div class="line"># parameter <span class="keywordflow">for</span> Butler-Volmer equations at ElectricChemo <span class="keyword">class</span></div>
<div class="line">set F = 96485.3329</div>
<div class="line">set Rr = 8.3144598</div>
<div class="line">set alpha_a = 0.5</div>
<div class="line">set alpha_c = 0.5</div>
<div class="line">set k_neg = 0.8 #to match porosity paper</div>
<div class="line">set k_pos = 0.8 #to match porosity paper</div>
<div class="line">set c_max_neg = 28.7e-3</div>
<div class="line">set c_max_pos = 37.5e-3</div>
<div class="line"></div>
<div class="line">end</div>
<div class="line"></div>
<div class="line"><span class="preprocessor"># parameter for thermal equations</span></div>
<div class="line"><span class="preprocessor"></span>subsection Thermal</div>
<div class="line">set lambda_neg = 1.04e6 #cite1</div>
<div class="line">set lambda_pos = 5e6  #cite1</div>
<div class="line">set lambda_sep = 0.33e6  #cite1</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">set density_neg = 2.5e-15  #cite1</div>
<div class="line">set density_pos = 2.5e-15  #cite1</div>
<div class="line">set density_sep = 1.1e-15  #cite1</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">set Cp_s_neg = 700e12  #cite1</div>
<div class="line">set Cp_s_pos = 700e12 #cite1</div>
<div class="line">set Cp_sep = 700e12  #cite1</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">set h = 5 #Heat transfer coefficient</div>
<div class="line">end</div>
<div class="line">            </div>
<div class="line">                    </div>
<div class="line"><span class="preprocessor">#==============================================================================</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor"># parameters reserved for deal.ii first level code:</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#nonLinear_method : classicNewton</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#solver_method (direct) : PETScsuperLU, PETScMUMPS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#solver_method (iterative) : PETScGMRES PETScBoomerAMG</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#relative_norm_tolerance, absolute_norm_tolerance, max_iterations</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#</span></div>
<div class="line"><span class="preprocessor"></span>subsection Nonlinear_solver</div>
<div class="line">        set nonLinear_method = classicNewton</div>
<div class="line">        set relative_norm_tolerance = 1.0e-10</div>
<div class="line">        set absolute_norm_tolerance = 1.0e-7</div>
<div class="line">        set max_iterations = 8</div>
<div class="line">end</div>
<div class="line">                        </div>
<div class="line">subsection Linear_solver</div>
<div class="line">        set solver_method = PETScMUMPS</div>
<div class="line">        set system_matrix_symmetricFlag = <span class="keyword">false</span> # <span class="keywordflow">default</span> is <span class="keyword">false</span></div>
<div class="line">end</div>
</div><!-- fragment --> <style>div.image img[src="10C-phis.png"]{width:800px;}</style>   <style>div.image img[src="10C-epl-thermal.png"]{width:800px;}</style>  <div class="image">
<img src="10C-phis.png" alt="10C-phis.png"/>
</div>
<p> <br/>
 </p>
<div class="image">
<img src="10C-epl-thermal.png" alt="10C-epl-thermal.png"/>
</div>
<p>Many more results can be found at paper: <b>Intercalation driven porosity effects on the electro-chemo-thermo-mechanical response in continuum models for battery material electrodes</b>, Z. Wang, J. Siegel, K. Garikipati, Journal of the Electrochemical Society, Vol. 164: A2199-A2212, 2017, doi:10.1149/2.0081712jes </p>
<h1><a class="anchor" id="com"></a>
Complete code</h1>
<p>The complete implementaion can be found at <a href="https://github.com/mechanoChem/mechanoChemFEM/tree/example/Battery%20model%20at%20electrode%20scale">Github</a>. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
